# Telegram Bot для Битрикс24 с поддержкой 152-ФЗ

Telegram-бот для работы с CRM Битрикс24, поддерживающий регистрацию пользователей с согласием на обработку персональных данных (152-ФЗ), создание сделок и административные функции.

## Возможности

### Пользовательский режим

#### Для всех пользователей:
- Приветствие и запрос согласия с политикой конфиденциальности (152-ФЗ)
- Регистрация с выбором роли (дизайнер/строитель/риелтор/партнер)
- Трекинг источников трафика через параметры start

#### Для дизайнеров:
- **Новая сделка**: создание сделок с указанием ФИО клиента, телефона, загрузкой PDF-проекта и комментарием
- **Мои сделки**: просмотр списка всех сделок дизайнера
- **Узнать статус**: проверка актуального статуса сделки по номеру
- **Реферальная программа**: информация о программе (в разработке)

### Административный режим

- **Выгрузка пользователей**: экспорт всех пользователей в Excel с полной информацией
- **Рассылка**: массовая отправка сообщений с выбором целевой аудитории по ролям
- Отслеживание заблокированных ботом пользователей

## Установка

### 1. Клонируйте репозиторий

```bash
git clone <repository_url>
cd 152bot
```

### 2. Установите зависимости

```bash
pip install -r requirements.txt
```

### 3. Настройте конфигурацию

Скопируйте `.env.example` в `.env` и заполните параметры:

```bash
cp .env.example .env
```

Отредактируйте `.env`:

```env
# Telegram Bot Token (получите у @BotFather)
BOT_TOKEN=your_bot_token_here

# ID администраторов (через запятую)
ADMIN_IDS=123456789,987654321

# Webhook URL для Битрикс24
BITRIX_WEBHOOK_URL=https://your-domain.bitrix24.ru/rest/1/your_webhook_code/

# Путь к базе данных
DATABASE_PATH=bot_database.db

# Ссылка на политику конфиденциальности
PRIVACY_POLICY_URL=https://example.com/privacy-policy

# Username менеджера для поддержки
MANAGER_USERNAME=username_manager
```

### 4. Настройка Битрикс24

#### Создание webhook в Битрикс24:

1. Перейдите в раздел **Разработчикам** → **Другое** → **Входящий webhook**
2. Создайте новый webhook с правами:
   - `crm` (все права на CRM)
3. Скопируйте URL webhook в `.env`

#### Создание пользовательских полей (опционально):

Для корректной работы рекомендуется создать следующие пользовательские поля:

**В контактах:**
- `UF_CRM_TELEGRAM_ID` - Число (Telegram ID пользователя)

**В сделках:**
- `UF_CRM_DESIGNER_ID` - Связь с контактом (ID дизайнера)
- `UF_CRM_PROJECT_FILE` - Строка (ссылка на файл проекта)

## Запуск бота

```bash
python bot.py
```

## Использование

### Для пользователей

1. Найдите бота в Telegram
2. Отправьте `/start` для начала работы
3. Примите политику конфиденциальности
4. Выберите роль (для полного функционала выберите "Дизайнер")
5. Пройдите регистрацию
6. Используйте меню для работы с сделками

#### Параметры start для трекинга источников:

```
https://t.me/your_bot?start=VK        - трафик из VK
https://t.me/your_bot?start=INST      - трафик из Instagram
https://t.me/your_bot?start=TG        - трафик из Telegram
https://t.me/your_bot?start=YTB       - трафик из YouTube
https://t.me/your_bot?start=QR        - трафик из QR-кода
```

### Для администраторов

1. Отправьте `/admin` для входа в админ-панель
2. Выберите нужное действие:
   - **Выгрузить пользователей**: получить Excel-файл со всеми пользователями
   - **Рассылка**: отправить сообщение всем или выбранной группе пользователей

## Структура проекта

```
152bot/
├── bot.py                      # Главный файл запуска
├── config.py                   # Конфигурация
├── database.py                 # Работа с базой данных
├── bitrix_api.py              # Интеграция с Битрикс24
├── keyboards.py                # Клавиатуры бота
├── states.py                   # FSM состояния
├── handlers/
│   ├── __init__.py
│   ├── registration.py        # Обработчики регистрации
│   ├── deals.py               # Обработчики сделок
│   └── admin.py               # Административные обработчики
├── requirements.txt           # Зависимости
├── .env.example              # Пример конфигурации
└── README.md                 # Документация
```

## База данных

Бот использует SQLite для хранения:
- Пользователей (с Telegram ID, ФИО, контактами, ролью, Bitrix ID)
- Сделок (кеш из Битрикс для быстрого доступа)
- Состояний FSM для многошаговых диалогов

## Требования

- Python 3.8+
- aiogram 3.7.0
- aiohttp 3.9.5
- python-dotenv 1.0.1
- aiosqlite 0.20.0
- openpyxl 3.1.2

## Безопасность и конфиденциальность

Бот разработан с соблюдением требований 152-ФЗ:
- Обязательное согласие на обработку персональных данных
- Ссылка на политику конфиденциальности
- Хранение информации о согласии пользователя
- Возможность отказа от использования бота

## Разработка

### Добавление новых ролей

Для добавления новых ролей с функционалом:

1. Добавьте роль в `config.py` в словарь `USER_ROLES`
2. Создайте обработчики в новом файле в `handlers/`
3. Зарегистрируйте router в `bot.py`

### Расширение функционала Битрикс

Все методы API Битрикс24 находятся в `bitrix_api.py`. Для добавления новых методов:

```python
async def your_new_method(self, params: Dict) -> Dict:
    return await self._make_request("crm.method.name", params)
```

## Поддержка

По всем вопросам обращайтесь к менеджеру, указанному в настройках бота.

## Лицензия

Proprietary - все права защищены
